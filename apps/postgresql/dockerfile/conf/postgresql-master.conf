# PostgreSQL 主服务器配置文件
# 基于 Alpine Linux 环境优化

#------------------------------------------------------------------------------
# 连接和认证
#------------------------------------------------------------------------------

# 监听地址
listen_addresses = '*'

# 端口
port = 5432

# 最大连接数
max_connections = 100

# 超级用户保留连接数
superuser_reserved_connections = 3

#------------------------------------------------------------------------------
# 内存设置
#------------------------------------------------------------------------------

# 共享缓冲区 (建议设置为系统内存的 25%)
shared_buffers = 256MB

# 有效缓存大小 (建议设置为系统内存的 75%)
effective_cache_size = 2GB

# 工作内存 (每个查询操作可用的内存)
work_mem = 8MB

# 维护工作内存 (用于维护操作如 VACUUM, CREATE INDEX 等)
maintenance_work_mem = 128MB

#------------------------------------------------------------------------------
# WAL (Write-Ahead Logging) 设置
#------------------------------------------------------------------------------

# WAL 级别 (replica 支持流复制)
wal_level = replica

# WAL 缓冲区
wal_buffers = 32MB

# 检查点完成目标 (0.0-1.0)
checkpoint_completion_target = 0.9

# 检查点超时
checkpoint_timeout = 5min

# 最大 WAL 大小
max_wal_size = 2GB

# 最小 WAL 大小
min_wal_size = 160MB

#------------------------------------------------------------------------------
# 复制设置
#------------------------------------------------------------------------------

# 最大 WAL 发送者数量
max_wal_senders = 3

# 最大复制槽数量
max_replication_slots = 3

# 保留的 WAL 大小 (PostgreSQL 13+ 使用 wal_keep_size 替代 wal_keep_segments)
wal_keep_size = 1GB

# 启用热备
hot_standby = on

#------------------------------------------------------------------------------
# 查询优化
#------------------------------------------------------------------------------

# 随机页面成本
random_page_cost = 1.1

# 有效 IO 并发
effective_io_concurrency = 200

# 并行工作进程
max_worker_processes = 8
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4

#------------------------------------------------------------------------------
# 日志设置
#------------------------------------------------------------------------------

# 日志目标
log_destination = 'stderr'

# 日志收集器
logging_collector = on

# 日志目录
log_directory = '/opt/logs/postgresql'

# 日志文件名
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# 日志轮转时间
log_rotation_age = 1d

# 日志轮转大小
log_rotation_size = 100MB

# 日志截断
log_truncate_on_rotation = on

# 日志级别
log_min_messages = warning
log_min_error_statement = error
# 慢查询日志配置
# 记录执行时间超过 1000ms 的语句 (0 表示记录所有语句，-1 表示不记录)
log_min_duration_statement = 1000

# 记录所有语句类型 (可选值: none, ddl, mod, all)
# none: 不记录任何语句
# ddl: 记录数据定义语句 (CREATE, ALTER, DROP 等)
# mod: 记录数据修改语句 (INSERT, UPDATE, DELETE 等)
# all: 记录所有语句
log_statement = 'mod'

# 记录连接和断开
log_connections = on
log_disconnections = on

# 记录主机名
log_hostname = on

# 记录时间戳
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 记录锁等待
log_lock_waits = on

# 记录临时文件
log_temp_files = 0

# 记录检查点
log_checkpoints = on

# 记录 WAL 统计
log_statement_stats = off
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off

#------------------------------------------------------------------------------
# 统计信息
#------------------------------------------------------------------------------

# 启用统计收集
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# 统计目标
default_statistics_target = 100

#------------------------------------------------------------------------------
# 自动清理
#------------------------------------------------------------------------------

# 启用自动清理
autovacuum = on

# 自动清理工作进程数
autovacuum_max_workers = 3

# 自动清理延迟
autovacuum_naptime = 1min

# 自动清理阈值
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50

# 自动清理比例因子
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1

# 自动清理成本延迟
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = 200

#------------------------------------------------------------------------------
# 客户端连接默认值
#------------------------------------------------------------------------------

# 默认事务隔离级别
default_transaction_isolation = 'read committed'

# 默认事务只读
default_transaction_read_only = off

# 默认事务延迟
default_transaction_deferrable = off

# 时区
timezone = 'Asia/Shanghai'

# 日期样式
datestyle = 'iso, mdy'

# 区域设置
lc_messages = 'en_US.utf8'    # 保持英文错误消息，便于调试
lc_monetary = 'zh_CN.utf8'    # 货币格式使用中文
lc_numeric = 'zh_CN.utf8'     # 数字格式使用中文
lc_time = 'zh_CN.utf8'        # 时间格式使用中文

# 默认文本搜索配置
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# 版本和平台兼容性
#------------------------------------------------------------------------------

# 数组空值
array_nulls = on

# 转义字符串警告
escape_string_warning = on

# 标准符合字符串
standard_conforming_strings = on

# 反斜杠转义
backslash_quote = safe_encoding

# 默认参数
default_with_oids = off

#------------------------------------------------------------------------------
# 扩展相关配置
#------------------------------------------------------------------------------

# 启用 TimescaleDB 预加载库
shared_preload_libraries = 'timescaledb'

# 如果安装了 PostGIS，以下设置有助于地理空间查询优化
# 随机页面成本 (SSD 存储可以设置为 1.0)
# random_page_cost = 1.0

# 有效 IO 并发 (对于地理空间查询可能需要调整)
# effective_io_concurrency = 200

# 工作内存 (地理空间查询可能需要更多内存)
# work_mem = 8MB

# 维护工作内存 (PostGIS 索引创建可能需要更多内存)
# maintenance_work_mem = 128MB
